// HX711 Smart Baseline Management System
// ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢

#include "HX711.h"

#define LOADCELL_DOUT_PIN  4
#define LOADCELL_SCK_PIN   3

HX711 scale;
float calibrationFactor = -369.726624; // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà calibrate ‡πÑ‡∏î‡πâ

// ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Baseline ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞
struct WaterBaseline {
    float emptyBowlWeight;        // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ä‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤
    float fullWaterWeight;        // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏° (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥)
    float currentWeight;          // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    float waterConsumed;          // ‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏î‡∏∑‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
    float evaporationRate;        // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢ (g/hour)
    
    unsigned long lastUpdateTime;     // ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    unsigned long lastRefillTime;     // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    unsigned long lastEvapCheckTime;  // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    
    bool needsRecalibration;      // ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö baseline ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    bool autoEvaporationMode;     // ‡πÇ‡∏´‡∏°‡∏î‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
};

WaterBaseline waterSystem;

// ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
#define REFILL_THRESHOLD 50.0f         // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 50g = ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥
#define EVAPORATION_CHECK_INTERVAL 3600000UL  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏ó‡∏∏‡∏Å 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
#define MAX_EVAPORATION_RATE 2.0f      // ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2g/hour
#define MIN_WATER_CHANGE 0.5f          // ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö

void setup() {
    Serial.begin(115200);
    Serial.println("\n=== HX711 Smart Baseline System ===");
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô HX711
    scale.begin(LOADCELL_DOUT_PIN, LOADCELL_SCK_PIN);
    delay(2000);
    
    if (!scale.is_ready()) {
        Serial.println("‚ùå HX711 ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°!");
        return;
    }
    
    scale.set_scale(calibrationFactor);
    scale.tare(20);
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    initWaterSystem();
    
    Serial.println("\n=== ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ===");
    Serial.println("'setup' - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà");
    Serial.println("'refill' - ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥");
    Serial.println("'status' - ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô");
    Serial.println("'auto' - ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
    Serial.println("'reset' - ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö");
    Serial.println("'test' - ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô");
}

void loop() {
    updateWaterSystem();
    
    if (Serial.available()) {
        String cmd = Serial.readString();
        cmd.trim();
        cmd.toLowerCase();
        
        if (cmd == "setup") {
            setupWaterSystem();
        }
        else if (cmd == "refill") {
            handleRefill();
        }
        else if (cmd == "status") {
            showStatus();
        }
        else if (cmd == "auto") {
            toggleAutoMode();
        }
        else if (cmd == "reset") {
            resetSystem();
        }
        else if (cmd == "test") {
            testSystem();
        }
        else {
            Serial.println("‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
        }
    }
    
    delay(1000);
}

void initWaterSystem() {
    Serial.println("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥...");
    
    waterSystem.emptyBowlWeight = 0.0;
    waterSystem.fullWaterWeight = 0.0;
    waterSystem.currentWeight = 0.0;
    waterSystem.waterConsumed = 0.0;
    waterSystem.evaporationRate = 0.5; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 0.5g/hour
    
    waterSystem.lastUpdateTime = millis();
    waterSystem.lastRefillTime = millis();
    waterSystem.lastEvapCheckTime = millis();
    
    waterSystem.needsRecalibration = true;
    waterSystem.autoEvaporationMode = true;
    
    Serial.println("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
}

void setupWaterSystem() {
    Serial.println("\n=== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥ ===");
    
    // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ä‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤
    Serial.println("‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏≠‡∏≤‡∏ô‡πâ‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î");
    Serial.println("‡∏û‡∏¥‡∏°‡∏û‡πå 'ok' ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß:");
    
    while(true) {
        if(Serial.available()) {
            String input = Serial.readString();
            input.trim();
            input.toLowerCase();
            if(input == "ok") break;
        }
        delay(100);
    }
    
    delay(2000);
    waterSystem.emptyBowlWeight = scale.get_units(10);
    Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ä‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤: " + String(waterSystem.emptyBowlWeight, 2) + "g");
    
    // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏°
    Serial.println("\n‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏°‡∏ä‡∏≤‡∏°");
    Serial.println("‡∏û‡∏¥‡∏°‡∏û‡πå 'ok' ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß:");
    
    while(true) {
        if(Serial.available()) {
            String input = Serial.readString();
            input.trim();
            input.toLowerCase();
            if(input == "ok") break;
        }
        delay(100);
    }
    
    delay(2000);
    waterSystem.fullWaterWeight = scale.get_units(10);
    waterSystem.currentWeight = waterSystem.fullWaterWeight;
    
    Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏°: " + String(waterSystem.fullWaterWeight, 2) + "g");
    Serial.println("‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥: " + String(waterSystem.fullWaterWeight - waterSystem.emptyBowlWeight, 2) + "g");
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
    waterSystem.waterConsumed = 0.0;
    waterSystem.lastRefillTime = millis();
    waterSystem.lastEvapCheckTime = millis();
    waterSystem.needsRecalibration = false;
    
    Serial.println("‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!");
}

void updateWaterSystem() {
    unsigned long currentTime = millis();
    
    // ‡∏≠‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    float newWeight = scale.get_units(3);
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥
    if (abs(newWeight - waterSystem.currentWeight) > 200) {
        Serial.println("‚ö†Ô∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏°‡∏≤‡∏Å: " + String(newWeight, 2) + "g");
        return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ
    }
    
    waterSystem.currentWeight = newWeight;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    if (waterSystem.autoEvaporationMode) {
        checkAutoRefill();
    }
    
    // ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢
    if (currentTime - waterSystem.lastEvapCheckTime > EVAPORATION_CHECK_INTERVAL) {
        compensateEvaporation();
        waterSystem.lastEvapCheckTime = currentTime;
    }
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏î‡∏∑‡πà‡∏°‡πÑ‡∏õ
    calculateWaterConsumption();
    
    waterSystem.lastUpdateTime = currentTime;
}

void checkAutoRefill() {
    float weightIncrease = waterSystem.currentWeight - waterSystem.fullWaterWeight;
    
    // ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ threshold = ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏´‡∏°‡πà
    if (weightIncrease > REFILL_THRESHOLD) {
        Serial.println("\nüîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥!");
        Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô: " + String(weightIncrease, 2) + "g");
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó baseline ‡πÉ‡∏´‡∏°‡πà
        waterSystem.fullWaterWeight = waterSystem.currentWeight;
        waterSystem.lastRefillTime = millis();
        waterSystem.waterConsumed = 0.0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
        
        Serial.println("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó baseline ‡πÉ‡∏´‡∏°‡πà: " + String(waterSystem.fullWaterWeight, 2) + "g");
    }
}

void compensateEvaporation() {
    unsigned long timeElapsed = millis() - waterSystem.lastEvapCheckTime;
    float hoursElapsed = timeElapsed / 3600000.0; // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    
    float evaporationAmount = waterSystem.evaporationRate * hoursElapsed;
    
    if (evaporationAmount > 0.1) { // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0.1g
        Serial.println("üí® ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢: " + String(evaporationAmount, 2) + "g");
        
        // ‡∏õ‡∏£‡∏±‡∏ö baseline ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏•‡∏á (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏£‡∏∞‡πÄ‡∏´‡∏¢)
        waterSystem.fullWaterWeight -= evaporationAmount;
        
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
        updateEvaporationRate();
    }
}

void updateEvaporationRate() {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
    unsigned long timeSinceRefill = millis() - waterSystem.lastRefillTime;
    float hoursSinceRefill = timeSinceRefill / 3600000.0;
    
    if (hoursSinceRefill > 1.0) {
        float totalEvaporation = waterSystem.fullWaterWeight - waterSystem.currentWeight + waterSystem.waterConsumed;
        float estimatedEvapRate = totalEvaporation / hoursSinceRefill;
        
        // ‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡πÅ‡∏ö‡∏ö smooth
        if (estimatedEvapRate > 0 && estimatedEvapRate < MAX_EVAPORATION_RATE) {
            waterSystem.evaporationRate = (waterSystem.evaporationRate * 0.8) + (estimatedEvapRate * 0.2);
        }
    }
}

void calculateWaterConsumption() {
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏î‡∏∑‡πà‡∏°‡πÑ‡∏õ = ‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏° - ‡∏ô‡πâ‡∏≥‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢
    float rawConsumption = waterSystem.fullWaterWeight - waterSystem.currentWeight;
    
    // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏≠‡∏≠‡∏Å
    unsigned long timeSinceRefill = millis() - waterSystem.lastRefillTime;
    float hoursElapsed = timeSinceRefill / 3600000.0;
    float evaporationAmount = waterSystem.evaporationRate * hoursElapsed;
    
    waterSystem.waterConsumed = rawConsumption - evaporationAmount;
    
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö
    if (waterSystem.waterConsumed < 0) {
        waterSystem.waterConsumed = 0;
    }
}

void handleRefill() {
    Serial.println("\nüö∞ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡∏ô‡∏ô‡∏ß‡∏•");
    Serial.println("‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏°‡∏ä‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå 'ok':");
    
    while(true) {
        if(Serial.available()) {
            String input = Serial.readString();
            input.trim();
            input.toLowerCase();
            if(input == "ok") break;
        }
        delay(100);
    }
    
    delay(2000);
    float newFullWeight = scale.get_units(10);
    
    Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°: " + String(waterSystem.fullWaterWeight, 2) + "g");
    Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏¥‡∏°: " + String(newFullWeight, 2) + "g");
    Serial.println("‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°: " + String(newFullWeight - waterSystem.currentWeight, 2) + "g");
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
    waterSystem.fullWaterWeight = newFullWeight;
    waterSystem.currentWeight = newFullWeight;
    waterSystem.lastRefillTime = millis();
    waterSystem.waterConsumed = 0.0;
    
    Serial.println("‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!");
}

void showStatus() {
    Serial.println("\n=== ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥ ===");
    Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ä‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡πà‡∏≤: " + String(waterSystem.emptyBowlWeight, 2) + "g");
    Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πá‡∏°: " + String(waterSystem.fullWaterWeight, 2) + "g");
    Serial.println("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: " + String(waterSystem.currentWeight, 2) + "g");
    Serial.println("‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏î‡∏∑‡πà‡∏°‡πÑ‡∏õ: " + String(waterSystem.waterConsumed, 2) + "g");
    Serial.println("‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏´‡∏¢: " + String(waterSystem.evaporationRate, 2) + "g/hour");
    
    unsigned long timeSinceRefill = millis() - waterSystem.lastRefillTime;
    Serial.println("‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥: " + String(timeSinceRefill / 3600000.0, 1) + " ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á");
    
    Serial.println("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: " + String(waterSystem.autoEvaporationMode ? "‡πÄ‡∏õ‡∏¥‡∏î" : "‡∏õ‡∏¥‡∏î"));
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
    float waterRemaining = waterSystem.fullWaterWeight - waterSystem.emptyBowlWeight - waterSystem.waterConsumed;
    float totalWater = waterSystem.fullWaterWeight - waterSystem.emptyBowlWeight;
    float percentRemaining = (waterRemaining / totalWater) * 100;
    
    Serial.println("‡∏ô‡πâ‡∏≥‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: " + String(percentRemaining, 1) + "%");
    Serial.println("======================");
}

void toggleAutoMode() {
    waterSystem.autoEvaporationMode = !waterSystem.autoEvaporationMode;
    Serial.println("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: " + String(waterSystem.autoEvaporationMode ? "‡πÄ‡∏õ‡∏¥‡∏î" : "‡∏õ‡∏¥‡∏î"));
}

void resetSystem() {
    Serial.println("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö...");
    initWaterSystem();
    Serial.println("‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á 'setup' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà");
}

void testSystem() {
    Serial.println("\n=== ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö ===");
    
    for (int i = 0; i < 10; i++) {
        updateWaterSystem();
        
        Serial.printf("Test %d: Weight=%.2fg, Consumed=%.2fg, Evap=%.3fg/h\n", 
                     i+1, waterSystem.currentWeight, waterSystem.waterConsumed, waterSystem.evaporationRate);
        
        delay(1000);
    }
    
    Serial.println("=== ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ===");
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏Å
bool isRealDrinking(float sessionDuration, float weightChange) {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    bool timeOK = sessionDuration >= 1.0; // ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    bool weightOK = weightChange >= MIN_WATER_CHANGE; // ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏£‡∏¥‡∏á
    bool reasonableAmount = weightChange <= 50.0; // ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50g ‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    
    return timeOK && weightOK && reasonableAmount;
}

float getCurrentWaterConsumption() {
    return waterSystem.waterConsumed;
}

void notifyRefill() {
    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥
    float waterRemaining = waterSystem.fullWaterWeight - waterSystem.emptyBowlWeight - waterSystem.waterConsumed;
    float totalWater = waterSystem.fullWaterWeight - waterSystem.emptyBowlWeight;
    float percentRemaining = (waterRemaining / totalWater) * 100;
    
    if (percentRemaining < 20) {
        Serial.println("‚ö†Ô∏è ‡∏ô‡πâ‡∏≥‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢! (" + String(percentRemaining, 1) + "%)");
    }
}
